<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bütçe Takip</title>
    <style>
        :root {
            --primary-bg: #e0e5ec;
            --card-bg: #ffffff;
            --text-color: #333;
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --danger-color: #e64b3c;
            --success-color: #28a745;
            --edit-color: #ffc107;
            --border-color: #d1d9e6;
            --shadow-light: rgba(255, 255, 255, 0.7);
            --shadow-dark: rgba(163, 177, 198, 0.6);
            --gradient-start: #007bff;
            --gradient-end: #0056b3;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 15px;
        }
        .container {
            width: 100%;
            max-width: 500px;
        }

        /* --- GİRİŞ EKRANI --- */
        #loginEkrani {
            width: 100%;
            max-width: 400px;
            margin-top: 10vh;
        }
        .login-kart {
            background-color: var(--card-bg); border-radius: 20px; padding: 40px 30px;
            text-align: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .login-kart h1 { color: var(--primary-color); margin-bottom: 10px; font-size: 1.8em; }
        .login-kart p { color: #6c757d; margin-bottom: 30px; }
        .login-kart .form-grup label { display: none; }
        .login-kart input { background-color: #f8f9fa; border: 1px solid #ced4da; text-align: center; }
        .login-kart.error input { animation: shake 0.5s; border-color: var(--danger-color); }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* --- ANA UYGULAMA --- */
        #anaUygulama { display: none; }
        .kart {
            background-color: var(--card-bg); border-radius: 15px; padding: 20px;
            margin-bottom: 20px; box-shadow: 5px 5px 15px var(--shadow-dark), -5px -5px 15px var(--shadow-light);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header-controls select { padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border-color); background-color: #fff; }
        #logoutBtn { background: none; border: none; color: var(--danger-color); font-weight: bold; cursor: pointer; padding: 8px 12px; border-radius: 8px; transition: background-color 0.2s; }
        #logoutBtn:hover { background-color: #f8d7da; }

        .ozet-alani { display: flex; justify-content: space-around; text-align: center; }
        .ozet-alani h3 { font-size: 0.9em; color: #606770; margin-bottom: 5px; font-weight: 500; }
        .ozet-alani p { font-size: 1.4em; font-weight: 700; } /* Rakam boyutu küçültüldü */
        .kalan-pozitif { color: var(--success-color); }
        .kalan-negatif { color: var(--danger-color); }

        .form-grup { margin-bottom: 15px; text-align: left; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em; }
        input[type="text"], input[type="number"], input[type="password"], select {
            width: 100%; padding: 12px; border: 1px solid var(--border-color);
            border-radius: 8px; font-size: 1em; background-color: #fff;
        }
        .gider-formu { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: flex-end; }
        
        button {
            width: 100%; padding: 14px; border: none; border-radius: 10px; color: white;
            font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
            background: linear-gradient(145deg, var(--gradient-end), var(--gradient-start));
            box-shadow: 3px 3px 8px #c1c1c1, -3px -3px 8px #ffffff;
        }
        button:hover { transform: translateY(-2px); box-shadow: 5px 5px 15px #b1b1b1, -5px -5px 15px #ffffff; }
        button:active { transform: translateY(1px); box-shadow: inset 2px 2px 5px #b1b1b1, inset -2px -2px 5px #ffffff; }

        .gider-listesi { list-style-type: none; padding: 0; }
        .gider-listesi li { display: flex; justify-content: space-between; align-items: center; padding: 12px 5px; border-bottom: 1px solid var(--border-color); font-size: 1.1em; }
        .gider-listesi li:last-child { border-bottom: none; }
        .gider-eylemleri { display: flex; gap: 10px; }
        .eylem-btn {
            background-color: transparent; min-width: 32px; height: 32px; border-radius: 50%;
            font-size: 1.2em; display: flex; justify-content: center; align-items: center; padding: 0;
            border: 1px solid var(--border-color); box-shadow: none;
        }
        .sil-btn { color: var(--danger-color); }
        .duzenle-btn { color: var(--edit-color); }

        #exportBtn { background: var(--success-color); margin-top: 15px; }

        /* --- MODAL --- */
        .modal-arka-plan {
            display: none; position: fixed; z-index: 100; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);
        }
        .modal-icerik {
            background-color: #fefefe; margin: 15% auto; padding: 25px;
            border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 15px;
        }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }

        /* --- DURUM MESAJI --- */
        .durum-mesaji {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 12px 25px; border-radius: 8px; color: #fff; z-index: 1001;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        .durum-mesaji.goster { opacity: 1; visibility: visible; }
        .durum-bilgi { background-color: #17a2b8; }
        .durum-basari { background-color: var(--success-color); }
        .durum-hata { background-color: var(--danger-color); }
    </style>
</head>
<body>

    <div id="loginEkrani" class="container">
        <div class="login-kart">
            <h1>BÜTÇE TAKİP</h1>
            <p>Devam etmek için lütfen giriş yapın.</p>
            <div class="form-grup">
                <input type="text" id="usernameInput" placeholder="Kullanıcı Adı">
            </div>
            <div class="form-grup">
                <input type="password" id="passwordInput" placeholder="Şifre">
            </div>
            <button id="loginBtn">Giriş Yap</button>
        </div>
    </div>

    <div id="anaUygulama" class="container">
        <!-- Ana uygulama içeriği dinamik olarak yüklenecek -->
    </div>
    
    <div id="durumMesaji" class="durum-mesaji"></div>

    <!-- Düzenleme Modalı -->
    <div id="duzenleModal" class="modal-arka-plan">
        <div class="modal-icerik">
            <h2>Gideri Düzenle</h2>
            <div class="form-grup">
                <label for="duzenleGiderKategori">Kategori</label>
                <select id="duzenleGiderKategori">
                    <option>Kira</option><option>Aidat</option><option>Kredi</option><option>K.Kartı</option><option>Servis</option><option>Diğer</option>
                </select>
            </div>
            <div class="form-grup" id="duzenleDigerGiderKutusu" style="display: none;">
                <label for="duzenleDigerGiderAdi">Gider Adı</label>
                <input type="text" id="duzenleDigerGiderAdi">
            </div>
            <div class="form-grup">
                <label for="duzenleGiderMiktari">Tutar (₺)</label>
                <input type="number" id="duzenleGiderMiktari">
            </div>
            <div class="modal-buttons">
                <button id="duzenlemeyiKaydetBtn">Kaydet</button>
                <button id="modalKapatBtn" style="background: #6c757d;">İptal</button>
            </div>
        </div>
    </div>


    <script>
        // --- API & GÜVENLİK ---
        const TOKEN_PART1 = 'ghp_2KS6iY7t1ka6bKyHwONJ';
        const TOKEN_PART2 = 'kXdwOUVhrU3PqlSX';
        const GITHUB_TOKEN = TOKEN_PART1 + TOKEN_PART2;
        const REPO_SAHIBI = 'gokhangeo';
        const REPO_ADI = 'hesap';
        const DOSYA_YOLU = 'data/butce_kayitlari.json';
        const API_URL = `https://api.github.com/repos/${REPO_SAHIBI}/${REPO_ADI}/contents/${DOSYA_YOLU}`;

        // --- GLOBAL DEĞİŞKENLER ---
        let tumVeriler = {};
        let seciliAy = '';
        let dosyaSHA = null;
        let duzenlenenGiderId = null;

        // --- DOM ELEMENTLERİ ---
        const loginEkrani = document.getElementById('loginEkrani');
        const anaUygulama = document.getElementById('anaUygulama');
        
        // --- OLAY DİNLEYİCİSİ ---
        document.addEventListener('DOMContentLoaded', init);

        function init() {
            // Ana uygulama HTML'ini dinamik olarak oluştur
            anaUygulama.innerHTML = `
                <div class="header-controls">
                    <select id="aySecici"></select>
                    <button id="logoutBtn">Çıkış Yap</button>
                </div>
                <div class="kart ozet-alani">
                    <div><h3>Maaş</h3><p id="gosterMaas">0 ₺</p></div>
                    <div><h3>Gider</h3><p id="gosterGider">0 ₺</p></div>
                    <div><h3>Kalan</h3><p id="gosterKalan">0 ₺</p></div>
                </div>
                <div class="kart">
                    <div class="form-grup">
                        <label for="maasInput">Seçili Ayın Net Maaşı (₺)</label>
                        <input type="number" id="maasInput" placeholder="Maaşınızı girin">
                    </div>
                </div>
                <div class="kart">
                    <h2>Yeni Gider Ekle</h2>
                    <div class="gider-formu">
                        <div class="form-grup"><label for="giderKategoriInput">Kategori</label><select id="giderKategoriInput"><option>Kira</option><option>Aidat</option><option>Kredi</option><option>K.Kartı</option><option>Servis</option><option>Diğer</option></select></div>
                        <div class="form-grup"><label for="giderMiktariInput">Tutar (₺)</label><input type="number" id="giderMiktariInput" placeholder="Tutar"></div>
                    </div>
                    <div class="form-grup" id="digerGiderAdiKutusu" style="display: none;"><label for="digerGiderAdiInput">Gider Adı (Örn: Alışveriş)</label><input type="text" id="digerGiderAdiInput"></div>
                    <button id="giderEkleBtn">Ekle & Kaydet</button>
                </div>
                <div class="kart">
                    <h2 id="giderListesiBaslik">Gider Listesi</h2>
                    <ul id="giderListesi"></ul>
                    <button id="exportBtn">Bu Ayı İndir (CSV)</button>
                </div>`;
            
            // Olay dinleyicilerini ata
            document.getElementById('loginBtn').addEventListener('click', girisYap);
            document.getElementById('logoutBtn').addEventListener('click', cikisYap);
            document.getElementById('aySecici').addEventListener('change', ayDegistir);
            document.getElementById('maasInput').addEventListener('change', maasiKaydet);
            document.getElementById('giderEkleBtn').addEventListener('click', giderEkle);
            document.getElementById('giderKategoriInput').addEventListener('change', () => {
                document.getElementById('digerGiderAdiKutusu').style.display = document.getElementById('giderKategoriInput').value === 'Diğer' ? 'block' : 'none';
            });
            document.getElementById('giderListesi').addEventListener('click', listeEylemi);
            document.getElementById('exportBtn').addEventListener('click', verileriDisaAktar);
            document.getElementById('modalKapatBtn').addEventListener('click', duzenlemeModaliniKapat);
            document.getElementById('duzenlemeyiKaydetBtn').addEventListener('click', duzenlemeyiKaydet);
            document.getElementById('duzenleGiderKategori').addEventListener('change', () => {
                document.getElementById('duzenleDigerGiderKutusu').style.display = document.getElementById('duzenleGiderKategori').value === 'Diğer' ? 'block' : 'none';
            });
            
            aySeciciDoldur();
            seciliAy = document.getElementById('aySecici').value;
        }

        // --- KARAKTER KODLAMA DÜZELTMESİ ---
        function utf8_to_b64(str) {
            return btoa(unescape(encodeURIComponent(str)));
        }
        function b64_to_utf8(str) {
            return decodeURIComponent(escape(atob(str)));
        }

        // --- GİRİŞ & OTURUM İŞLEMLERİ ---
        function girisYap() {
            if (document.getElementById('usernameInput').value === '4G' && document.getElementById('passwordInput').value === '503344') {
                loginEkrani.style.display = 'none';
                anaUygulama.style.display = 'block';
                verileriCek();
            } else {
                const loginKart = document.querySelector('.login-kart');
                loginKart.classList.add('error');
                setTimeout(() => loginKart.classList.remove('error'), 500);
            }
        }
        function cikisYap() {
            anaUygulama.style.display = 'none';
            loginEkrani.style.display = 'block';
            document.getElementById('usernameInput').value = '';
            document.getElementById('passwordInput').value = '';
        }

        // --- VERİ İŞLEMLERİ (API) ---
        async function verileriCek() {
            durumGoster('Veriler yükleniyor...', 'bilgi');
            try {
                const response = await fetch(API_URL, { headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json' }});
                if (response.status === 404) {
                    tumVeriler = {}; dosyaSHA = null;
                    durumGoster('Hoş geldiniz! Yeni kayıt dosyası oluşturulacak.', 'bilgi', 3000);
                } else if (!response.ok) {
                    throw new Error(`API Hatası: ${response.statusText}`);
                } else {
                    const data = await response.json();
                    dosyaSHA = data.sha;
                    tumVeriler = JSON.parse(b64_to_utf8(data.content));
                    durumGoster('Veriler başarıyla yüklendi.', 'basari', 2000);
                }
                arayuzuGuncelle();
            } catch (error) {
                console.error('Veri çekme hatası:', error);
                durumGoster(`Veriler yüklenemedi: ${error.message}`, 'hata', 5000);
            }
        }
        async function verileriKaydet() {
            durumGoster('Kaydediliyor...', 'bilgi', 2000);
            try {
                const icerikBase64 = utf8_to_b64(JSON.stringify(tumVeriler, null, 2));
                const govde = {
                    message: `Bütçe güncellemesi: ${seciliAy}`,
                    content: icerikBase64,
                    sha: dosyaSHA
                };
                if (!dosyaSHA) delete govde.sha;
                const response = await fetch(API_URL, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json' },
                    body: JSON.stringify(govde)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP hatası! Durum: ${response.status}`);
                }
                const data = await response.json();
                dosyaSHA = data.content.sha;
                durumGoster('Başarıyla kaydedildi!', 'basari', 2000);
            } catch (error) {
                console.error('Veri kaydetme hatası:', error);
                durumGoster(`Kaydedilemedi: ${error.message}`, 'hata', 8000);
            }
        }

        // --- ARAYÜZ GÜNCELLEME ---
        function arayuzuGuncelle() {
            if (!tumVeriler[seciliAy]) {
                tumVeriler[seciliAy] = { maas: 0, giderler: [] };
            }
            const aylikVeri = tumVeriler[seciliAy];
            document.getElementById('maasInput').value = aylikVeri.maas > 0 ? aylikVeri.maas : '';
            
            const toplamGider = aylikVeri.giderler.reduce((toplam, gider) => toplam + gider.miktar, 0);
            const kalanPara = aylikVeri.maas - toplamGider;
            
            document.getElementById('gosterMaas').textContent = `${formatla(aylikVeri.maas)} ₺`;
            document.getElementById('gosterGider').textContent = `${formatla(toplamGider)} ₺`;
            const gosterKalan = document.getElementById('gosterKalan');
            gosterKalan.textContent = `${formatla(kalanPara)} ₺`;
            gosterKalan.className = kalanPara >= 0 ? 'kalan-pozitif' : 'kalan-negatif';
            
            const ayAdi = new Date(seciliAy + '-01').toLocaleString('tr-TR', { month: 'long', year: 'numeric' });
            document.getElementById('giderListesiBaslik').textContent = `${ayAdi} Gider Listesi`;

            const giderListesi = document.getElementById('giderListesi');
            giderListesi.innerHTML = '';
            if (aylikVeri.giderler.length === 0) {
                giderListesi.innerHTML = "<li style='color:#888; justify-content:center;'>Bu ay için gider eklenmedi.</li>";
            } else {
                aylikVeri.giderler.forEach(gider => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>${gider.ad} - <strong>${formatla(gider.miktar)} ₺</strong></span>
                        <div class="gider-eylemleri">
                            <button class="eylem-btn duzenle-btn" data-id="${gider.id}" title="Düzenle">&#9998;</button>
                            <button class="eylem-btn sil-btn" data-id="${gider.id}" title="Sil">&times;</button>
                        </div>
                    `;
                    giderListesi.appendChild(li);
                });
            }
        }
        
        // --- UYGULAMA MANTIĞI ---
        function aySeciciDoldur() {
            const aySecici = document.getElementById('aySecici');
            const simdi = new Date();
            for (let i = 3; i >= -12; i--) {
                const tarih = new Date(simdi.getFullYear(), simdi.getMonth() - i, 1);
                const ayFormat = `${tarih.getFullYear()}-${(tarih.getMonth() + 1).toString().padStart(2, '0')}`;
                const ayAdi = tarih.toLocaleString('tr-TR', { month: 'long', year: 'numeric' });
                const option = new Option(ayAdi, ayFormat, i === 0, i === 0);
                aySecici.add(option);
            }
        }
        function ayDegistir() {
            seciliAy = document.getElementById('aySecici').value;
            arayuzuGuncelle();
        }
        function maasiKaydet() {
            const yeniMaas = parseFloat(document.getElementById('maasInput').value) || 0;
            if (yeniMaas !== tumVeriler[seciliAy].maas) {
                tumVeriler[seciliAy].maas = yeniMaas;
                verileriKaydet();
                arayuzuGuncelle();
            }
        }
        function giderEkle() {
            const giderKategoriInput = document.getElementById('giderKategoriInput');
            const digerGiderAdiInput = document.getElementById('digerGiderAdiInput');
            let ad = giderKategoriInput.value;
            if (ad === 'Diğer') {
                ad = digerGiderAdiInput.value.trim() || 'Diğer Gider';
            }
            const miktar = parseFloat(document.getElementById('giderMiktariInput').value);
            if (isNaN(miktar) || miktar <= 0) {
                durumGoster('Lütfen geçerli bir tutar girin.', 'hata', 3000);
                return;
            }
            tumVeriler[seciliAy].giderler.push({ id: Date.now(), ad, miktar });
            
            document.getElementById('giderMiktariInput').value = '';
            digerGiderAdiInput.value = '';
            giderKategoriInput.value = 'Kira';
            document.getElementById('digerGiderAdiKutusu').style.display = 'none';
            arayuzuGuncelle();
            verileriKaydet();
        }

        function listeEylemi(event) {
            const button = event.target.closest('.eylem-btn');
            if (!button) return;

            const id = parseInt(button.dataset.id);
            if (button.classList.contains('sil-btn')) {
                giderSil(id);
            } else if (button.classList.contains('duzenle-btn')) {
                duzenlemeModaliniAc(id);
            }
        }

        function giderSil(id) {
            tumVeriler[seciliAy].giderler = tumVeriler[seciliAy].giderler.filter(g => g.id !== id);
            arayuzuGuncelle();
            verileriKaydet();
        }

        // --- DÜZENLEME MODALI FONKSİYONLARI ---
        function duzenlemeModaliniAc(id) {
            duzenlenenGiderId = id;
            const gider = tumVeriler[seciliAy].giderler.find(g => g.id === id);
            if (!gider) return;

            const kategoriSelect = document.getElementById('duzenleGiderKategori');
            const digerAdiInput = document.getElementById('duzenleDigerGiderAdi');
            const digerKutusu = document.getElementById('duzenleDigerGiderKutusu');
            document.getElementById('duzenleGiderMiktari').value = gider.miktar;
            
            const sabitKategoriler = Array.from(kategoriSelect.options).map(opt => opt.value);
            if (sabitKategoriler.includes(gider.ad)) {
                kategoriSelect.value = gider.ad;
                digerKutusu.style.display = 'none';
            } else {
                kategoriSelect.value = 'Diğer';
                digerAdiInput.value = gider.ad;
                digerKutusu.style.display = 'block';
            }
            document.getElementById('duzenleModal').style.display = 'block';
        }

        function duzenlemeModaliniKapat() {
            document.getElementById('duzenleModal').style.display = 'none';
            duzenlenenGiderId = null;
        }

        function duzenlemeyiKaydet() {
            const giderIndex = tumVeriler[seciliAy].giderler.findIndex(g => g.id === duzenlenenGiderId);
            if (giderIndex === -1) return;

            let yeniAd = document.getElementById('duzenleGiderKategori').value;
            if (yeniAd === 'Diğer') {
                yeniAd = document.getElementById('duzenleDigerGiderAdi').value.trim() || 'Diğer Gider';
            }
            const yeniMiktar = parseFloat(document.getElementById('duzenleGiderMiktari').value);
            if (isNaN(yeniMiktar) || yeniMiktar <= 0) {
                alert('Lütfen geçerli bir tutar girin.');
                return;
            }

            tumVeriler[seciliAy].giderler[giderIndex] = { ...tumVeriler[seciliAy].giderler[giderIndex], ad: yeniAd, miktar: yeniMiktar };
            duzenlemeModaliniKapat();
            arayuzuGuncelle();
            verileriKaydet();
        }

        // --- YARDIMCI FONKSİYONLAR ---
        function verileriDisaAktar() {
            const aylikVeri = tumVeriler[seciliAy];
            if (!aylikVeri) return;
            let csvIcerik = "data:text/csv;charset=utf-8,";
            csvIcerik += "Tip,Açıklama,Tutar\n";
            csvIcerik += `Maaş,Aylık Net Maaş,${aylikVeri.maas}\n`;
            aylikVeri.giderler.forEach(g => {
                csvIcerik += `Gider,${g.ad.replace(/,/g, '')},-${g.miktar}\n`;
            });
            const toplamGider = aylikVeri.giderler.reduce((t, g) => t + g.miktar, 0);
            csvIcerik += `\nBakiye,Toplam Kalan,${aylikVeri.maas - toplamGider}\n`;

            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvIcerik));
            link.setAttribute("download", `${seciliAy}_bütçe.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        function durumGoster(mesaj, tip, sure = 5000) {
            const durumMesaji = document.getElementById('durumMesaji');
            durumMesaji.textContent = mesaj;
            durumMesaji.className = `durum-mesaji durum-${tip} goster`;
            setTimeout(() => { durumMesaji.classList.remove('goster'); }, sure);
        }
        function formatla(sayi) {
            return new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(sayi || 0);
        }
    </script>
</body>
</html>

