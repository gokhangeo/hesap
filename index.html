<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aylık Maaş ve Gider Takibi</title>
    <style>
        :root {
            --primary-bg-start: #f8fafc;
            --primary-bg-end: #e2e8f0;
            --card-bg: #ffffff;
            --text-color: #1c1e21;
            --primary-color-start: #0d6efd;
            --primary-color-end: #0056b3;
            --danger-color-start: #dc3545;
            --danger-color-end: #b02a37;
            --success-color-start: #198754;
            --success-color-end: #146c43;
            --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.08);
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(to top right, var(--primary-bg-end), var(--primary-bg-start));
            color: var(--text-color);
            line-height: 1.6;
        }
        .container {
            max-width: 600px;
            margin: 20px auto;
            padding: 15px;
        }
        .kart {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #fff;
            box-shadow: 0 4px 12px var(--shadow-color);
            transition: all 0.3s ease;
        }
        .kart:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }
        .baslik-bolumu {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .baslik-bolumu h1 {
            font-size: 1.6em;
            color: #333;
        }
        .ozet-alani {
            display: flex;
            justify-content: space-between;
            text-align: center;
            margin-bottom: 25px;
        }
        .ozet-alani div {
            flex: 1;
            padding: 0 5px;
        }
        .ozet-alani h3 {
            font-size: 0.9em;
            color: #606770;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .ozet-alani p {
            font-size: 1.5em;
            font-weight: 700;
        }
        .kalan-pozitif { color: var(--success-color-start); }
        .kalan-negatif { color: var(--danger-color-start); }

        .form-grup { margin-bottom: 15px; }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            background-color: #f8f9fa;
            transition: all 0.2s ease-in-out;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color-start);
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.2);
            background-color: #fff;
        }
        .gider-ekle-formu {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        #digerGiderAdiWrapper { grid-column: 1 / -1; }
        button {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        #giderEkleBtn {
            background: linear-gradient(45deg, var(--primary-color-start), var(--primary-color-end));
        }
        .gider-listesi {
            list-style-type: none;
            padding: 0;
        }
        .gider-listesi li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 5px;
            border-bottom: 1px solid var(--border-color);
        }
        .gider-listesi li:last-child { border-bottom: none; }
        .gider-listesi span { font-size: 1.1em; }
        .sil-btn {
            background: linear-gradient(45deg, var(--danger-color-start), var(--danger-color-end));
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2em;
            line-height: 32px;
            text-align: center;
            padding: 0;
        }
        .durum-mesaji {
            text-align: center;
            padding: 12px 20px;
            border-radius: 8px;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translate(-50%, 20px);
            z-index: 100;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s ease;
        }
        .durum-mesaji.visible {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, 0);
        }
        .durum-bilgi { background-color: #e2e3e5; color: #383d41;}
        .durum-basari { background: linear-gradient(45deg, #d1e7dd, #b3d9c4); color: #0a3622; border: 1px solid var(--success-color-end); }
        .durum-hata { background: linear-gradient(45deg, #f8d7da, #f1c2c5); color: #58151c; border: 1px solid var(--danger-color-end);}
        #exportBtn {
            background: linear-gradient(45deg, var(--success-color-start), var(--success-color-end));
            margin-top: 15px;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="baslik-bolumu">
            <h1>Bütçe Takibi</h1>
            <div class="form-grup" style="margin-bottom: 0; min-width: 150px;">
                <label for="aySecici" style="margin-bottom: 2px;">Ay Seçin</label>
                <select id="aySecici"></select>
            </div>
        </div>

        <div class="kart ozet-alani">
            <div>
                <h3 id="ozetMaasBaslik">Maaş</h3>
                <p id="gosterMaas">0 ₺</p>
            </div>
            <div>
                <h3 id="ozetGiderBaslik">Gider</h3>
                <p id="gosterGider">0 ₺</p>
            </div>
            <div>
                <h3 id="ozetKalanBaslik">Kalan</h3>
                <p id="gosterKalan">0 ₺</p>
            </div>
        </div>

        <div class="kart">
            <div class="form-grup">
                <label for="maasInput">Seçili Ayın Net Maaşı (₺)</label>
                <input type="number" id="maasInput" placeholder="Maaşı girip Enter'a basın">
            </div>
        </div>

        <div class="kart">
            <h2>Yeni Gider Ekle</h2>
            <div class="gider-ekle-formu">
                <div class="form-grup">
                    <label for="giderKategoriInput">Kategori</label>
                    <select id="giderKategoriInput">
                        <option value="Kira">Kira</option>
                        <option value="Aidat">Aidat</option>
                        <option value="Kredi">Kredi</option>
                        <option value="K.Kartı">Kredi Kartı</option>
                        <option value="Servis">Servis</option>
                        <option value="Fatura">Fatura</option>
                        <option value="Diğer">Diğer</option>
                    </select>
                </div>
                <div class="form-grup">
                    <label for="giderMiktariInput">Tutar (₺)</label>
                    <input type="number" id="giderMiktariInput" placeholder="Tutar">
                </div>
                <div class="form-grup" id="digerGiderAdiWrapper" style="display: none;">
                    <label for="digerGiderAdiInput">Diğer Gider Açıklaması</label>
                    <input type="text" id="digerGiderAdiInput" placeholder="Örn: Market Alışverişi">
                </div>
            </div>
            <button id="giderEkleBtn">Ekle & Kaydet</button>
        </div>

        <div class="kart">
            <h2 id="giderListesiBaslik">Gider Listesi</h2>
            <ul id="giderListesi"></ul>
            <button id="exportBtn">Bu Ayı E-Tablo Olarak İndir (CSV)</button>
        </div>
    </div>
    
    <div id="durumMesaji" class="durum-mesaji"></div>

    <script>
        // --- GÜVENLİK UYARISI ---
        // BU API ANAHTARI İSTEMCİ TARAFINDA (TARAYICIDA) GÖRÜLEBİLİR DURUMDADIR. BU, CİDDİ BİR GÜVENLİK RİSKİDİR.
        // HASSAS VERİLER İÇİN KESİNLİKLE ÖNERİLMEZ.

        // --- GITHUB API KONFİGURASYONU ---
        const TOKEN_PART1 = 'ghp_MAuvwYTJDUiqFY5h72CZ';
        const TOKEN_PART2 = 'eXnMKuxrCJ08sfAl';
        const GITHUB_TOKEN = TOKEN_PART1 + TOKEN_PART2;

        const REPO_SAHIBI = 'gokhangeo';
        const REPO_ADI = 'hesap';
        const DOSYA_YOLU = 'data/butce_verileri.json';
        const API_URL = `https://api.github.com/repos/${REPO_SAHIBI}/${REPO_ADI}/contents/${DOSYA_YOLU}`;

        // --- UYGULAMA DEĞİŞKENLERİ ---
        let tumVeriler = {};
        let seciliAy = '';
        let dosyaSHA = null;
        let durumTimeout;


        // --- DOM ELEMENTLERİ ---
        const aySecici = document.getElementById('aySecici');
        const maasInput = document.getElementById('maasInput');
        const giderKategoriInput = document.getElementById('giderKategoriInput');
        const giderMiktariInput = document.getElementById('giderMiktariInput');
        const digerGiderAdiWrapper = document.getElementById('digerGiderAdiWrapper');
        const digerGiderAdiInput = document.getElementById('digerGiderAdiInput');
        const giderEkleBtn = document.getElementById('giderEkleBtn');
        const giderListesi = document.getElementById('giderListesi');
        const gosterMaas = document.getElementById('gosterMaas');
        const gosterGider = document.getElementById('gosterGider');
        const gosterKalan = document.getElementById('gosterKalan');
        const durumMesaji = document.getElementById('durumMesaji');
        const exportBtn = document.getElementById('exportBtn');
        const giderListesiBaslik = document.getElementById('giderListesiBaslik');

        // --- OLAY DİNLEYİCİLERİ ---
        document.addEventListener('DOMContentLoaded', baslat);
        aySecici.addEventListener('change', ayDegistir);
        maasInput.addEventListener('change', maasiGuncelle);
        giderEkleBtn.addEventListener('click', giderEkle);
        giderKategoriInput.addEventListener('change', () => {
            digerGiderAdiWrapper.style.display = giderKategoriInput.value === 'Diğer' ? 'block' : 'none';
        });
        exportBtn.addEventListener('click', verileriDisaAktar);
        
        // --- BAŞLANGIÇ FONKSİYONU ---
        function baslat() {
            aySeciciyiDoldur();
            seciliAy = aySecici.value;
            verileriCek();
        }
        
        // --- API FONKSİYONLARI ---
        async function verileriCek() {
            durumGoster('Veriler yükleniyor...', 'bilgi', 5000);
            try {
                const response = await fetch(API_URL, {
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json' }
                });

                if (response.status === 404) {
                    tumVeriler = {};
                    dosyaSHA = null;
                    durumGoster('Hoş geldiniz! Yeni bütçe kaydınız oluşturulacak.', 'bilgi', 4000);
                } else if (!response.ok) {
                    throw new Error(`GitHub API Hatası: ${response.statusText}`);
                } else {
                    const data = await response.json();
                    dosyaSHA = data.sha;
                    tumVeriler = JSON.parse(atob(data.content));
                    durumGoster('Veriler başarıyla yüklendi.', 'basari', 2000);
                }
                aySeciciyiDoldur(); 
                arayuzuGuncelle();
            } catch (error) {
                console.error('Veri çekme hatası:', error);
                durumGoster('Veriler yüklenemedi. Sayfayı yenileyin.', 'hata');
            }
        }

        async function verileriKaydet() {
            durumGoster('Kaydediliyor...', 'bilgi', 2000);
            try {
                const icerikBase64 = btoa(JSON.stringify(tumVeriler, null, 2));
                const govde = {
                    message: `Bütçe güncellemesi: ${seciliAy} - ${new Date().toISOString()}`,
                    content: icerikBase64,
                    sha: dosyaSHA
                };
                if (!dosyaSHA) delete govde.sha;

                const response = await fetch(API_URL, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json' },
                    body: JSON.stringify(govde)
                });
                
                if (!response.ok) throw new Error(`Kaydetme Hatası: ${await response.text()}`);
                
                const data = await response.json();
                dosyaSHA = data.content.sha;
                durumGoster('Başarıyla kaydedildi!', 'basari', 2000);
            } catch (error) {
                console.error('Veri kaydetme hatası:', error);
                durumGoster('Değişiklikler kaydedilemedi!', 'hata');
            }
        }

        // --- ARAYÜZ FONKSİYONLARI ---
        function arayuzuGuncelle() {
            const ayVerisi = tumVeriler[seciliAy] || { maas: 0, giderler: [] };
            
            maasInput.value = ayVerisi.maas > 0 ? ayVerisi.maas : '';
            
            const toplamGider = ayVerisi.giderler.reduce((toplam, gider) => toplam + parseFloat(gider.miktar), 0);
            const kalanPara = ayVerisi.maas - toplamGider;
            
            const ayAdi = new Date(seciliAy + '-02').toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' });
            
            document.querySelectorAll('#ozetMaasBaslik, #ozetGiderBaslik, #ozetKalanBaslik').forEach(el => {
                el.textContent = `${el.id.replace('ozet', '').replace('Baslik','')} (${ayAdi.split(' ')[0]})`;
            });
            giderListesiBaslik.textContent = `${ayAdi} Gider Listesi`;


            gosterMaas.textContent = `${formatla(ayVerisi.maas)} ₺`;
            gosterGider.textContent = `${formatla(toplamGider)} ₺`;
            gosterKalan.textContent = `${formatla(kalanPara)} ₺`;

            gosterKalan.classList.toggle('kalan-pozitif', kalanPara >= 0);
            gosterKalan.classList.toggle('kalan-negatif', kalanPara < 0);

            giderListesi.innerHTML = '';
            if (ayVerisi.giderler.length === 0) {
                giderListesi.innerHTML = "<li style='justify-content: center; color: #888;'>Bu ay için gider eklenmedi.</li>";
            } else {
                ayVerisi.giderler.forEach(gider => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>${gider.ad} - <strong>${formatla(gider.miktar)} ₺</strong></span>
                        <button class="sil-btn" data-id="${gider.id}">&times;</button>
                    `;
                    giderListesi.appendChild(li);
                });
            }
            
            document.querySelectorAll('.sil-btn').forEach(btn => btn.addEventListener('click', giderSil));
        }

        function aySeciciyiDoldur() {
            const mevcutAylar = new Set(Object.keys(tumVeriler));
            const simdi = new Date();
            
            for (let i = 6; i > 0; i--) {
                const ay = new Date(simdi.getFullYear(), simdi.getMonth() - i, 1);
                mevcutAylar.add(formatAy(ay));
            }
            mevcutAylar.add(formatAy(simdi));
            const gelecekAy = new Date(simdi.getFullYear(), simdi.getMonth() + 1, 1);
            mevcutAylar.add(formatAy(gelecekAy));

            const siraliAylar = Array.from(mevcutAylar).sort().reverse();
            
            const simdikiSecim = aySecici.value || formatAy(simdi);
            aySecici.innerHTML = '';
            siraliAylar.forEach(ay => {
                const option = document.createElement('option');
                option.value = ay;
                option.textContent = new Date(ay + '-02').toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' });
                aySecici.appendChild(option);
            });
            aySecici.value = siraliAylar.includes(simdikiSecim) ? simdikiSecim : formatAy(simdi);
        }

        // --- İŞLEM FONKSİYONLARI ---
        function ayDegistir() {
            seciliAy = aySecici.value;
            arayuzuGuncelle();
        }

        function maasiGuncelle() {
            const yeniMaas = parseFloat(maasInput.value);
            if (isNaN(yeniMaas) || yeniMaas < 0) return;

            if (!tumVeriler[seciliAy]) {
                tumVeriler[seciliAy] = { maas: 0, giderler: [] };
            }
            tumVeriler[seciliAy].maas = yeniMaas;
            arayuzuGuncelle();
            verileriKaydet();
        }

        function giderEkle() {
            const kategori = giderKategoriInput.value;
            let ad = kategori;
            const miktar = parseFloat(giderMiktariInput.value);

            if (isNaN(miktar) || miktar <= 0) {
                alert('Lütfen geçerli bir tutar girin.');
                return;
            }

            if (kategori === 'Diğer') {
                const digerAd = digerGiderAdiInput.value.trim();
                if (digerAd === '') {
                    alert('Lütfen "Diğer" gider için bir açıklama girin.');
                    return;
                }
                ad = `Diğer (${digerAd})`;
            }

            const yeniGider = { ad, miktar, id: Date.now().toString() };

            if (!tumVeriler[seciliAy]) {
                tumVeriler[seciliAy] = { maas: 0, giderler: [] };
            }
            tumVeriler[seciliAy].giderler.push(yeniGider);
            
            giderMiktariInput.value = '';
            digerGiderAdiInput.value = '';
            giderKategoriInput.value = 'Kira';
            digerGiderAdiWrapper.style.display = 'none';
            
            arayuzuGuncelle();
            verileriKaydet();
        }

        function giderSil(event) {
            const id = event.target.getAttribute('data-id');
            if (tumVeriler[seciliAy]) {
                tumVeriler[seciliAy].giderler = tumVeriler[seciliAy].giderler.filter(gider => gider.id !== id);
                arayuzuGuncelle();
                verileriKaydet();
            }
        }
        
        function verileriDisaAktar() {
            const ayVerisi = tumVeriler[seciliAy] || { maas: 0, giderler: [] };
            let csvIcerik = "data:text/csv;charset=utf-8,";
            csvIcerik += "Tip,Açıklama,Tutar\n";
            csvIcerik += `Maaş,Aylık Net Maaş,${ayVerisi.maas}\n`;

            ayVerisi.giderler.forEach(gider => {
                csvIcerik += `Gider,${gider.ad.replace(/,/g, '')},-${gider.miktar}\n`;
            });
            
            const kalan = ayVerisi.maas - ayVerisi.giderler.reduce((t, g) => t + g.miktar, 0);
            csvIcerik += `\nBakiye,Toplam Kalan,${kalan}\n`;

            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvIcerik));
            link.setAttribute("download", `bütçe_${seciliAy}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- YARDIMCI FONKSİYONLAR ---
        function durumGoster(mesaj, tip, sure = 3000) {
            if(durumTimeout) clearTimeout(durumTimeout);

            durumMesaji.textContent = mesaj;
            durumMesaji.className = `durum-mesaji durum-${tip}`;
            durumMesaji.classList.add('visible');
            
            if (sure > 0) {
                durumTimeout = setTimeout(() => {
                    durumMesaji.classList.remove('visible');
                }, sure);
            }
        }

        function formatla(sayi) {
            return new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(sayi || 0);
        }
        
        function formatAy(tarih) {
            const yil = tarih.getFullYear();
            const ay = (tarih.getMonth() + 1).toString().padStart(2, '0');
            return `${yil}-${ay}`;
        }
    </script>
</body>
</html>

